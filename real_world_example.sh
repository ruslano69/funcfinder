#!/bin/bash

echo "========================================="
echo "–†–ï–ê–õ–¨–ù–´–ô WORKFLOW –° FUNCFINDER"
echo "–°—Ü–µ–Ω–∞—Ä–∏–π: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –±–æ–ª—å—à–æ–π —Ñ—É–Ω–∫—Ü–∏–∏"
echo "========================================="
echo ""

# –ü—Ä–æ–±–ª–µ–º–∞: —Ñ—É–Ω–∫—Ü–∏—è FindFunctions –≤ finder.go —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è (128 —Å—Ç—Ä–æ–∫)

echo "üîç –®–∞–≥ 1: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–±–ª–µ–º—ã"
echo "----------------------------------------"
echo "–ò—â–µ–º —Å–∞–º—ã–µ –±–æ–ª—å—à–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ..."
echo ""

for file in finder.go python_finder.go sanitizer.go; do
    echo "=== $file ==="
    ./funcfinder --inp "$file" --source go --map --json | \
        jq -r 'to_entries[] | "\(.key): \(.value.end - .value.start) lines"' | \
        sort -t: -k2 -rn | head -3
done
echo ""

echo "‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –±–æ–ª—å—à–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏:"
echo "  - FindFunctions (finder.go): 128 —Å—Ç—Ä–æ–∫ - –¢–†–ï–ë–£–ï–¢ –†–ï–§–ê–ö–¢–û–†–ò–ù–ì–ê"
echo "  - CleanLine (sanitizer.go): 85 —Å—Ç—Ä–æ–∫ - –¢–†–ï–ë–£–ï–¢ –†–ï–§–ê–ö–¢–û–†–ò–ù–ì–ê"
echo ""

echo "üìñ –®–∞–≥ 2: –ê–Ω–∞–ª–∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏"
echo "----------------------------------------"
echo "–ò–∑–≤–ª–µ–∫–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞..."
echo ""
./funcfinder --inp finder.go --source go --func FindFunctions --extract | head -30
echo "..."
echo "(–ø–æ–∫–∞–∑–∞–Ω–æ –ø–µ—Ä–≤—ã–µ 30 —Å—Ç—Ä–æ–∫ –∏–∑ 128)"
echo ""

echo "ü§ñ –®–∞–≥ 3: AI-–∞—Å—Å–∏—Å—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑"
echo "----------------------------------------"
echo "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ AI —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏:"
echo ""
echo "–¢–æ–∫–µ–Ω—ã –±–µ–∑ funcfinder: ~$(wc -c < finder.go | awk '{print int($1/4)}')"
EXTRACTED_TOKENS=$(./funcfinder --inp finder.go --source go --func FindFunctions --extract | wc -c | awk '{print int($1/4)}')
echo "–¢–æ–∫–µ–Ω—ã —Å funcfinder: ~$EXTRACTED_TOKENS"
REDUCTION=$((100 - ($EXTRACTED_TOKENS * 100 / $(wc -c < finder.go | awk '{print int($1/4)}'))))
echo "–≠–∫–æ–Ω–æ–º–∏—è: $REDUCTION%"
echo ""

echo "üìä –®–∞–≥ 4: –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è"
echo "----------------------------------------"
echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º funcfinder –¥–ª—è —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫..."
echo ""

# –ü–æ–¥—Å—á–µ—Ç –º–µ—Ç—Ä–∏–∫
JSON=$(./funcfinder --inp finder.go --source go --map --json)
echo "–§–∞–π–ª: finder.go"
echo "  –í—Å–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–π: $(echo "$JSON" | jq 'length')"
echo "  –°—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä: $(echo "$JSON" | jq '[.[] | .end - .start] | add / length | floor') —Å—Ç—Ä–æ–∫"
echo "  –°–∞–º–∞—è –±–æ–ª—å—à–∞—è: $(echo "$JSON" | jq -r '[to_entries[] | {name:.key, size:(.value.end - .value.start)}] | max_by(.size) | "\(.name) (\(.size) —Å—Ç—Ä–æ–∫)"')"
echo ""

echo "üéØ –®–∞–≥ 5: –ü–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞"
echo "----------------------------------------"
echo "–ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ funcfinder:"
echo ""
echo "FindFunctions –º–æ–∂–Ω–æ —Ä–∞–∑–±–∏—Ç—å –Ω–∞:"
echo "  1. parseFileContent() - —á—Ç–µ–Ω–∏–µ –∏ –ø–∞—Ä—Å–∏–Ω–≥ —Ñ–∞–π–ª–∞"
echo "  2. detectFunctionBoundaries() - –ø–æ–∏—Å–∫ –≥—Ä–∞–Ω–∏—Ü —Ñ—É–Ω–∫—Ü–∏–π"
echo "  3. extractFunctionBody() - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–ª–∞ —Ñ—É–Ω–∫—Ü–∏–∏"
echo "  4. buildResult() - —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞"
echo ""
echo "–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:"
echo "  - 4 —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ ~30 —Å—Ç—Ä–æ–∫ –≤–º–µ—Å—Ç–æ 1 —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ 128 —Å—Ç—Ä–æ–∫"
echo "  - –£–ª—É—á—à–µ–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç–∏"
echo "  - –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞"
echo ""

echo "‚úÖ –®–∞–≥ 6: –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞"
echo "----------------------------------------"
echo "–ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º funcfinder –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:"
echo ""
echo "$ ./funcfinder --inp finder.go --source go --map --json | jq"
echo "..."
echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ < 50 —Å—Ç—Ä–æ–∫ ‚úÖ"
echo ""

echo "========================================="
echo "–í–´–í–û–î"
echo "========================================="
echo ""
echo "funcfinder –ø–æ–º–æ–≥:"
echo "  ‚úÖ –ò–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏"
echo "  ‚úÖ –ò–∑–≤–ª–µ—á—å –∫–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (—ç–∫–æ–Ω–æ–º–∏—è $REDUCTION% —Ç–æ–∫–µ–Ω–æ–≤)"
echo "  ‚úÖ –°–æ–±—Ä–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π"
echo "  ‚úÖ –°–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥"
echo "  ‚úÖ –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã"
echo ""
echo "–í—Ä–µ–º—è –Ω–∞ –∞–Ω–∞–ª–∏–∑: <1 –º–∏–Ω—É—Ç–∞"
echo "–≠–∫–æ–Ω–æ–º–∏—è AI —Ç–æ–∫–µ–Ω–æ–≤: $REDUCTION%"
echo "========================================="
